<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="layui/css/layui.css"/>
		<style type="text/css">
			#demo{width: 30%;}
			#table{width: 50%;position: absolute;right: 30px;top:0;}
			#table1{width: 50%;position: absolute;right: 30px;top:100px;}
			#table2{width: 50%;position: absolute;right: 30px;top:200px;}
			#table thead th{text-align: center;}
			#table tbody td:nth-last-of-type(1),#table tbody td:nth-last-of-type(2){text-align: center;}
			#tform{position: relative;width: 600px;height: auto;display: none;padding: 20px 0 50px;}
			#sbtn{position: absolute;left: 50%;bottom: 0;margin-left: -46px;}
			.picbox{width: 480px;height: auto;border: 1px solid #DDDDDD;text-align: center;padding: 8px 0;}
			#newImg{opacity: 0;}
		</style>
	</head>
	<body>
		<div id="demo">
			
		</div>

		<table id="table" class="layui-table">
			
		</table>	
		<form class="layui-form layui-form-pane" id="tform">
			
		</form>
		
	</body>
	
	<script src="js/const.js" type="text/javascript" charset="utf-8"></script>
	<script src="layui/layui.all.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		layui.use("element",function(){
			var $= layui.$;
			$.ajax({
				type:"get",
				url:window.PRJ_ROOT+"/getTableTree",
				async:true,
				success:function(res){
					var data = JSON.parse(res);
					var dataId;
					layui.tree({
					  elem: '#demo' //传入元素选择器
					  ,nodes: data,
					  click: function(node){
					    console.log(node.id) //node即为当前点击的节点数据
					    if (dataId==node.id) {
					    	return;
					    } else{
					    	$.ajax({
					    		type:"post",
					    		url:window.PRJ_ROOT+"/click",
					    		async:true,
					    		data:{"id":node.id},
					    		dataType:"json",
					    		success:function(res){
					    			console.log(res)
					    			if (res.data.imagePath) {
					    				$("#table").html('<colgroup><col width="150"><col width="80"><col width="80"><col width="80"></colgroup><thead><tr><th>描述</th><th>图片</th><th>修改</th><th>删除</th></tr></thead><tbody><tr><td>'+res.data.question+'</td><td><img src=images/'+res.data.imagePath+'  layer-src=images/'+res.data.imagePath+'></td><td><button class="layui-btn" id="trevise">修改</button></td><td><button class="layui-btn layui-btn-danger" id="tdel">删除</button></td></tr></tody>')
					    				//form
					    				$("#tform").html('<div class="layui-form-item"><label class="layui-form-label">描述</label><div class="layui-input-block"><input type="text" name="question" id="Fquestion"  class="layui-input" value='+res.data.question+'></div></div><div class="layui-form-item"><label class="layui-form-label">图片</label><div class="layui-input-block picbox"><img src=images/'+res.data.imagePath+' width="70%" id="timg"><input type="file" id="newImg" name="file"></div></div><button type="button" class="layui-btn layui-btn-normal" id="sbtn">确认修改</button>')
					    				//图片点击放大
					    				layer.photos({
										  photos: '#table'
										  ,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
										});										
										$("#trevise").click(function(){
											layer.open({
												title:"修改信息",
												type: 1,
												content: $('#tform'),
												area: ['600px','600px'],
												scrollbar:false
											})
										})
										//form表单图片绑定file
										$("#timg").click(function(){
											$("#newImg").trigger("click");
										})
										//图片预览
										$("#newImg").on("change",function(){
											var objUrl = getObjectURL(this.files[0]) ; //获取图片的路径，该路径不是图片在本地的路径
											if (objUrl) {
												$("#timg").attr("src", objUrl) ; //将图片路径存入src中，显示出图片
											}
										})
										$("#sbtn").click(function(){
											var Formdata1 = new FormData($("#tform")[0]);
											Formdata1.delete("question");
											var Fdata = {"question":$("#Fquestion").val(),"id":node.id}
											console.log(Fdata)
											Formdata1.append("data",Fdata)
											console.log(Formdata1.get("data"))
											$.ajax({
												url: window.PRJ_ROOT+"/editIsmp",  
									            type: 'POST',  
									            data: Formdata1, 
									            cache: false,  
									            processData: false,  
									            contentType: false,
									            success:function(res){
									            	layer.msg(JSON.parse(res).msg)
									            }
											});
										})
										
					    			} else if(res.data.answer){
					    				$("#table").html('<colgroup><col><col width="150"><col width="300"><col width="80"><col width="80"></colgroup><thead><tr><th>问题</th><th>关键字</th><th>回答</th><th>修改</th><th>删除</th></tr></thead><tbody><tr><td>'+res.data.question+'</td><td>'+res.data.keyWord+'</td><td>'+res.data.answer+'</td><td><button class="layui-btn" id="trevise">修改</button></td><td><button class="layui-btn layui-btn-danger" id="tdel">删除</button></td></tr></tody>')
					    			}else{
					    				if(res.data.isQa==0){
					    					var Qadata = "否";
					    				}else{
					    					var Qadata = "是";
					    				}
					    				$("#table").html('<colgroup><col><col width="150"><col width="150"><col width="80"><col width="80"></colgroup><thead><tr><th>问题</th><th>关键字</th><th>是否Qa问答</th><th>修改</th><th>删除</th></tr></thead><tbody><tr><td>'+res.data.question+'</td><td>'+res.data.keyWord+'</td><td>'+Qadata+'</td><td><button class="layui-btn" id="trevise">修改</button></td><td><button class="layui-btn layui-btn-danger" id="tdel">删除</button></td></tr></tody>')
					    			}
					    			//删除
					    			$("#tdel").click(function(){
					    				if (res.data.isBase==0) {
					    					var delMsg = "此标题下还有子内容，删除将一并删除，无法撤回"
					    				} else{
					    					var delMsg = "确认删除嘛？删除将无法撤回"
					    				}
					    				layer.open({
									        type: 1
									        ,title: false //不显示标题栏
									        ,closeBtn: false
									        ,area: '300px;'
									        ,shade: 0.8
									        ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
									        ,btn: ['确认删除', '我再想想']
									        ,btnAlign: 'c'
									        ,moveType: 1 //拖拽模式，0或者1
									        ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">'+delMsg+'</div>'
									        ,success: function(layero){
									          var btn = layero.find('.layui-layer-btn');
									          btn.find('.layui-layer-btn0').click(function(){
									          	$.ajax({
									          		type:"post",
									          		url:window.PRJ_ROOT+"/delete",
									          		async:true,
									          		data:{"id":res.data.id},
									          		success:function(res){
									          			layer.msg(JSON.parse(res).msg)
									          			window.location.reload()
									          		}
									          	});
									          });
									        }
									      });
					    			})
					    		}
					    	});
					    }
					    dataId = node.id;
					  }
					});
				}
			});
		})
//图片预览	
function getObjectURL(file) {
var url = null ;
if (window.createObjectURL!=undefined) { // basic
url = window.createObjectURL(file) ;
} else if (window.URL!=undefined) { // mozilla(firefox)
url = window.URL.createObjectURL(file) ;
} else if (window.webkitURL!=undefined) { // webkit or chrome
url = window.webkitURL.createObjectURL(file) ;
}
return url ;
}		
		
	</script>
</html>
